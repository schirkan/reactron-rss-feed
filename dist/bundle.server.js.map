{"version":3,"file":"bundle.server.js","sources":["../src/server/services/RssFeedService.ts","../src/server/index.ts"],"sourcesContent":["import { IReactronServiceContext } from '@schirkan/reactron-interfaces';\r\nimport { IRssFeedServiceOptions } from 'src/common/interfaces/IRssFeedServiceOptions';\r\nimport { IRssFeedService } from 'src/common/interfaces/IRssFeedService';\r\nimport { IRssFeed } from 'src/common/interfaces/IRssFeed';\r\nimport Parser, { Output } from 'rss-parser';\r\nimport * as request from 'request-promise-native';\r\n\r\ninterface ICacheItem {\r\n  timestamp: number;\r\n  result: Promise<any>;\r\n}\r\n\r\nexport class RssFeedService implements IRssFeedService {\r\n  private options: IRssFeedServiceOptions;\r\n  private cache: { [url: string]: ICacheItem } = {};\r\n\r\n  constructor(private context: IReactronServiceContext) { }\r\n\r\n  public async setOptions(options: IRssFeedServiceOptions): Promise<void> {\r\n    this.options = options;\r\n  }\r\n\r\n  public async getOptions(): Promise<Readonly<IRssFeedServiceOptions>> {\r\n    return this.options;\r\n  }\r\n\r\n  public async getFeedEntries(url: string): Promise<IRssFeed> {\r\n    return this.getOrCreate<IRssFeed>(url, async () => {\r\n      const response = await this.getResponseInternal<string>('get', url);\r\n      let parser = new Parser();\r\n      let feed = await parser.parseString(response);\r\n      return RssFeedService.mapToRssFeed(feed);\r\n    });\r\n  }\r\n\r\n  public static mapToRssFeed(data: Output): IRssFeed {\r\n    const feed: IRssFeed = {\r\n      description: data.description,\r\n      feedUrl: data.feedUrl,\r\n      link: data.link,\r\n      title: data.title,\r\n      items: []\r\n    };\r\n    if (data.items) {\r\n      feed.items = data.items.map(x => ({\r\n        link: x.link,\r\n        guid: x.guid,\r\n        title: x.title,\r\n        pubDate: x.pubDate,\r\n        creator: x.creator,\r\n        content: x.content,\r\n        isoDate: x.isoDate,\r\n        categories: x.categories,\r\n        contentSnippet: x.contentSnippet,\r\n      }));\r\n    }\r\n    return feed;\r\n  }\r\n\r\n  private async getResponseInternal<TResponse>(method: 'get' | 'post', url: string,\r\n    requestOptions?: request.RequestPromiseOptions): Promise<TResponse> {\r\n    this.context.log.debug('fetch', url);\r\n    requestOptions = { ...requestOptions, rejectUnauthorized: false, resolveWithFullResponse: true };\r\n\r\n    try {\r\n      let response: request.FullResponse | undefined;\r\n      switch (method) {\r\n        case \"get\":\r\n          response = await request.get(url, requestOptions);\r\n          break;\r\n        case \"post\":\r\n          requestOptions.headers![\"Content-Type\"] = \"application/x-www-form-urlencoded\";\r\n          response = await request.post(url, requestOptions);\r\n          break;\r\n      }\r\n      if (!response) {\r\n        throw new Error('response is undefined');\r\n      }\r\n      if (response.statusCode !== 200) {\r\n        this.context.log.error(response.statusMessage, response.body);\r\n        throw new Error(response.statusMessage);\r\n      }\r\n      return response.body;\r\n    } catch (error) {\r\n      this.context.log.error(error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  private async getOrCreate<TResponse>(key: string, creator: () => Promise<TResponse>): Promise<TResponse> {\r\n    const now = Date.now();\r\n    const validCacheTime = now - (this.options.cacheDuration * 60 * 1000);\r\n\r\n    // check timestamp\r\n    if (this.cache[key] && this.cache[key].timestamp < validCacheTime) {\r\n      delete (this.cache[key]);\r\n    }\r\n\r\n    if (!this.cache[key]) {\r\n      this.cache[key] = {\r\n        timestamp: now,\r\n        result: creator()\r\n      };\r\n    } else {\r\n      this.context.log.debug('cache hit');\r\n    }\r\n\r\n    return this.cache[key].result;\r\n  }\r\n}","import { IReactronServiceDefinition } from '@schirkan/reactron-interfaces';\r\nimport { RssFeedService } from './services/RssFeedService';\r\n\r\n// export interfaces\r\nexport * from '../common/interfaces/IRssFeed';\r\nexport * from '../common/interfaces/IRssFeedService';\r\nexport * from '../common/interfaces/IRssFeedServiceOptions';\r\n\r\n// export reactron service definition\r\nexport const services: IReactronServiceDefinition[] = [{\r\n  description: 'Service for RSS Feeds',\r\n  displayName: 'RSS Feed Service',\r\n  fields: [{\r\n    defaultValue: 5,\r\n    description: 'Cache duration in minutes',\r\n    displayName: 'Cache duration (min)',\r\n    name: 'cacheDuration',\r\n    valueType: 'number',\r\n    minValue: 0,\r\n    maxValue: 60,\r\n    stepSize: 1\r\n  }],\r\n  name: 'RssFeedService',\r\n  service: RssFeedService\r\n}];"],"names":["request.get","request.post"],"mappings":"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"}