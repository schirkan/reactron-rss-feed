{"version":3,"file":"bundle.server.js","sources":["../src/server/services/RssFeedService.ts","../src/server/index.ts"],"sourcesContent":["import { IReactronServiceContext } from '@schirkan/reactron-interfaces';\r\nimport * as request from 'request-promise-native';\r\nimport { IRssFeedServiceOptions } from 'src/common/interfaces/IRssFeedServiceOptions';\r\nimport { IRssFeedService } from 'src/common/interfaces/IRssFeedService';\r\nimport { IRssFeed } from 'src/common/interfaces/IRssFeed';\r\n\r\ninterface ICacheItem {\r\n  timestamp: number;\r\n  result: Promise<any>;\r\n}\r\n\r\nexport class RssFeedService implements IRssFeedService {\r\n  private options: IRssFeedServiceOptions;\r\n  private cache: { [url: string]: ICacheItem } = {};\r\n\r\n  constructor(private context: IReactronServiceContext) { }\r\n\r\n  public async setOptions(options: IRssFeedServiceOptions): Promise<void> {\r\n    this.options = options;\r\n  }\r\n\r\n  public async getOptions(): Promise<Readonly<IRssFeedServiceOptions>> {\r\n    return this.options;\r\n  }\r\n\r\n  getFeedEntries(url: string): Promise<IRssFeed> {\r\n    const result = this.getOrCreate<IRssFeed>(url, () => {\r\n      return this.getResponseInternal('get', url, {}, RssFeedService.mapToRssFeed);\r\n    });\r\n    return result;\r\n  }\r\n\r\n  public static mapToRssFeed(data: any): IRssFeed {\r\n    return data; // TODO\r\n  }\r\n\r\n  private async getResponseInternal<TResponse>(method: 'get' | 'post', url: string,\r\n    requestOptions: request.RequestPromiseOptions, mapper: (response: any) => TResponse): Promise<TResponse> {\r\n    this.context.log.debug('fetch', url);\r\n    requestOptions = { ...requestOptions, json: true, rejectUnauthorized: false, resolveWithFullResponse: true };\r\n\r\n    try {\r\n      let response: request.FullResponse | undefined;\r\n      switch (method) {\r\n        case \"get\":\r\n          response = await request.get(url, requestOptions);\r\n          break;\r\n        case \"post\":\r\n          requestOptions.headers![\"Content-Type\"] = \"application/x-www-form-urlencoded\";\r\n          response = await request.post(url, requestOptions);\r\n          break;\r\n      }\r\n      if (!response) {\r\n        throw new Error('response is undefined');\r\n      }\r\n      if (response.statusCode !== 200) {\r\n        this.context.log.error(response.statusMessage, response.body);\r\n        throw new Error(response.statusMessage);\r\n      }\r\n      this.context.log.debug(response.body);\r\n      return mapper(response.body);\r\n    } catch (error) {\r\n      this.context.log.error(error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  private async getOrCreate<TResponse>(key: string, creator: () => Promise<TResponse>): Promise<TResponse> {\r\n    const now = Date.now();\r\n    const validCacheTime = now - (this.options.cacheDuration * 60 * 1000);\r\n\r\n    // check timestamp\r\n    if (this.cache[key] && this.cache[key].timestamp < validCacheTime) {\r\n      delete (this.cache[key]);\r\n    }\r\n\r\n    if (!this.cache[key]) {\r\n      this.cache[key] = {\r\n        timestamp: now,\r\n        result: creator()\r\n      };\r\n    } else {\r\n      this.context.log.debug('cache hit');\r\n    }\r\n\r\n    return this.cache[key].result;\r\n  }\r\n}","import { IReactronServiceDefinition } from '@schirkan/reactron-interfaces';\r\nimport { RssFeedService } from './services/RssFeedService';\r\n\r\n// export interfaces\r\nexport * from '../common/interfaces/IRssFeed';\r\nexport * from '../common/interfaces/IRssFeedService';\r\nexport * from '../common/interfaces/IRssFeedServiceOptions';\r\n\r\n// export reactron service definition\r\nexport const services: IReactronServiceDefinition[] = [{\r\n  description: 'Service for public transport in germany',\r\n  displayName: 'Public transport information service',\r\n  fields: [{\r\n    defaultValue: 5,\r\n    description: 'Cache duration in minutes',\r\n    displayName: 'Cache duration (min)',\r\n    name: 'cacheDuration',\r\n    valueType: 'number',\r\n    minValue: 0,\r\n    maxValue: 60,\r\n    stepSize: 1\r\n  }],\r\n  name: 'PublicTransportService',\r\n  service: RssFeedService\r\n}];"],"names":["request.get","request.post"],"mappings":"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"}